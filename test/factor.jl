@testset "factor" begin
    data = matread(datafile("lpw_est_data.mat"))["est_data"]
    tb = Tables.table(data)
    xbal = data[3:end,1:8]
    es = trues(size(xbal,1))
    # Only unobserved factors
    f1 = Factor(xbal, 3, es)
    @test f1.svdca isa SDDcache
    @test response(f1) === f1.Y
    @test modelmatrix(f1) === f1.fac
    @test coef(f1) === f1.Λ
    @test residuals(f1) === f1.resid
    @test r2(f1) === f1.r2

    # Compare results with Matlab code from Stock and Watson (2016)
    # Make modifications in data/src/lpw_savedata.m to get Matlab results
    @test abs.(f1.fac[1,:]) ≈
        abs.([0.669750255362180, -1.415042540425748, -0.279535312367630]) atol=1e-10
    @test abs.(f1.fac[10,:]) ≈
        abs.([2.845425512378275, -0.906029272016824, 0.752341491236444]) atol=1e-10
    @test abs.(f1.fac[20,:]) ≈
        abs.([1.221141212862983, -0.516732212536293, -0.068575843021814]) atol=1e-10
    @test abs.(f1.fac[222,:]) ≈
        abs.([0.300027230626971, -0.168284777077276, -1.054070197848704]) atol=1e-10
    @test abs.(f1.Λ') ≈
        abs.([1.198841672616891 -0.526447148356210 0.154628303713676;
        0.161815191521853  -0.167943288447379  -0.018940733365788;
        0.263000440561341  -0.177311336672019   0.138590988831216;
        1.428534542807724   0.898523395588427  -0.182792943881696;
        0.954618585128196   0.657125274360260  -0.105312247322756;
        1.646099062580699  -0.769146225709081   0.446119942679932;
        0.000260114239986   0.003061919517216   0.001130474019592;
       -0.146023181302217  -0.210229201098867   1.690952422003901]) atol=1e-10
    @test r2(f1) ≈ [0.547498003171410, 0.538207271565816, 0.522485207652153,
        0.845287219432025, 0.776753874267359, 0.442968927667726,
        0.718135497358341, 0.911622832625205] atol=1e-10

    f11 = Factor(xbal, nothing, 3, es, svdalg=QRIteration())
    @test f11.svdca isa SVDcache
    @test f11.fac ≈ f1.fac
    @test f11.Λ ≈ f1.Λ
    @test sprint(show, f11) == "222×3 Factor{Float64, SVDcache{Float64}}"
    @test sprint(show, MIME("text/plain"), f11, context=:displaysize=>(14,120)) == """
        222×3 Factor{Float64, SVDcache{Float64}} with 3 unobserved factors and 0 observed factor:
          -0.66975    1.41504   0.279535
           1.21566   -0.693909  0.541543
           ⋮                    
          -0.300027   0.168285  1.05407
         3×8 Loading matirx:
          -1.19884   -0.161815   -0.263     -1.42853   -0.954619  -1.6461    -0.000260114   0.146023
           0.526447   0.167943    0.177311  -0.898523  -0.657125   0.769146  -0.00306192    0.210229
          -0.154628   0.0189407  -0.138591   0.182793   0.105312  -0.44612   -0.00113047   -1.69095
         R-squared by column:
          0.547498  0.538207  0.522485  0.845287  0.776754  0.442969  0.718135  0.911623"""

    f = fit(Factor, tb, 1:8, [], 3, subset=(1:224).>2)
    @test f.fac ≈ f1.fac
    @test f.Λ ≈ f1.Λ
    f = fit(Factor, tb, 1:8, nothing, 3, subset=(1:224).>2)
    @test f.fac ≈ f1.fac

    # Only observed factors
    w = data[3:end,1:2]
    f2 = Factor(xbal, w, 2, es)
    @test f2.fac == w
    @test f2.Λ' ≈ [1.008190053248771  -1.202238634380183;
        0.005237739852161   0.231138917436696;
        0.075523509028555   0.036999767091460;
        0.454460174372052  -0.183640105645053;
        0.246619287143147  -0.006821196237709;
        0.668053327773079  -0.196720248983012;
       -0.000042935672262  -0.000150555252075;
       -0.019511821996927  -0.033173202160798] atol=1e-10
    @test r2(f2) ≈ [0.955138631506611, 0.240703689955749, 0.132870765518692,
        0.224901666724074, 0.146392692912193, 0.205313169418025,
        0.003382799320984, 0.002086843582111] atol=1e-10
    @test sprint(show, f2) == "222×2 Factor{Float64, Nothing}"
    @test sprint(show, MIME("text/plain"), f2, context=:displaysize=>(10,120)) == """
        222×2 Factor{Float64, Nothing} with 0 unobserved factor and 2 observed factors:
          1.91341  1.33595
          ⋮        
         2×8 Loading matirx:
          ⋮      ⋱  
         R-squared by column:
          0.955139  0.240704  0.132871  0.224902  0.146393  0.205313  0.0033828  0.00208684"""
    f = fit(Factor, tb, 1:8, 1:2, 2, subset=(1:224).>2)
    @test f.fac ≈ f2.fac
    @test f.Λ ≈ f2.Λ

    w = data[3:end,1:1]
    f3 = Factor(xbal, w, 4, es)
    @test f3.fac[:,1:1] == w
    @test abs.(f3.fac[1,2:end]) ≈
        abs.([0.867830419938244, -1.543465356847842, -0.229706167547361]) atol=1e-10
    @test abs.(f3.fac[10,2:end]) ≈
        abs.([3.067726702798948, -1.039315184216688, 0.797685166720545]) atol=1e-10
    @test abs.(f3.fac[20,2:end]) ≈
        abs.([1.594104756289584, -0.766947757961741, 0.018660320681523]) atol=1e-10
    @test abs.(f3.fac[222,2:end]) ≈
        abs.([0.471083625613415, -0.257574652429074, -1.028655851298754]) atol=1e-10
    @test abs.(f3.Λ') ≈
        abs.([0.750012249591323   0.247827072086147  -0.059068787148612   0.012599387049350;
        -0.062485283908465   0.244453619582157  -0.213342550565296  -0.004784124891124;
        -0.049602168355206   0.324727523538282  -0.207545763059661   0.147618996013489;
        -0.041258054065395   1.468401285732195   0.884276996915713  -0.175182549235959;
        -0.105630183560382   1.083471561390694   0.591512031144294  -0.081696098012485;
         0.090474634346315   1.443438531556565  -0.513837658085527   0.338039048679876;
        -0.000012024477945   0.000301026441247   0.003025013006327   0.001135937330830;
        -0.017558241349469  -0.125007158462481  -0.222807063196741   1.696797360798171
        ]) atol=1e-10
    @test r2(f3) ≈ [0.854448198643454, 0.713594412687064, 0.568249391571677,
        0.840943720623983, 0.793689215013341, 0.384770466378939,
        0.709901507240683, 0.916329969396382] atol=1e-7
    @test sprint(show, f3) == "222×4 Factor{Float64, SDDcache{Float64}}"
    @test sprint(show, MIME("text/plain"), f3, context=:displaysize=>(12,120)) == """
        222×4 Factor{Float64, SDDcache{Float64}} with 3 unobserved factors and 1 observed factor:
          1.91341  -0.86783   1.54347   0.229706
          ⋮                             
          1.46324  -0.471084  0.257575  1.02866
         4×8 Loading matirx:
          0.750012  -0.0624853  -0.0496022  -0.0412581  -0.10563  0.0904746  -1.20245e-5  -0.0175582
          ⋮                                                       ⋮                       
         R-squared by column:
          0.854448  0.713594  0.568249  0.840944  0.793689  0.38477  0.709902  0.91633"""

    f = fit(Factor, tb, 1:8, 1:1, 4, subset=(1:224).>2, svdalg=QRIteration())
    @test f.svdca isa SVDcache
    @test f.fac ≈ f3.fac
    @test f.Λ ≈ f3.Λ

    fit!(f3, maxiter=1)
    @test abs.(f3.fac[10,2:end]) ≈
        abs.([3.024379205864252, -0.984613178278491, 0.775423193098402]) atol=1e-10
    @test abs.(f3.Λ') ≈
        abs.([0.707091315743808   0.351151136957706  -0.154200941555442   0.045291972989540;
        -0.055890052928274   0.228818516057032  -0.197366447432946  -0.010298549287021;
        -0.047620855764629   0.320090306937657  -0.202381200391591   0.145954520979494;
        -0.048389662236820   1.486546086421081   0.873048795893932  -0.175310532492739;
        -0.102879083520594   1.077954317693319   0.602964874215342  -0.089404229150349;
         0.003041081006660   1.642453287940112  -0.767545257285204   0.445649705482416;
         0.000008934939656   0.000249402661984   0.003066623290719   0.001129092425029;
        -0.017134344601979  -0.125481814960387  -0.219249527953531   1.693601876644949
        ]) atol=1e-10
end
